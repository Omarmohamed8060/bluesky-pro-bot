generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/// Stores Bluesky accounts used for sending outreach.
model Account {
  id                   String  @id @default(cuid())
  handle               String  @unique
  label                String?
  did                  String? @unique
  displayName          String?
  encryptedAppPassword String
  status               String  @default("ACTIVE")
  rateLimitPerHour     Int     @default(20)
  rateLimitPerDay      Int     @default(200)
  lastLoginAt          DateTime?
  lastError            String?
  cooldownUntil        DateTime?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  campaigns            Campaign[]
  logs                 LogEntry[]
}

model Template {
  id          String  @id @default(cuid())
  name        String
  description String?
  type        String  @default("DM")
  body        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  campaigns   Campaign[]
}

model TargetList {
  id          String   @id @default(cuid())
  name        String
  description String?
  targetsJson String   @default("[]")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  campaigns   Campaign[]
}

model Campaign {
  id             String  @id @default(cuid())
  name           String
  type           String  @default("DM")
  status         String  @default("QUEUED")
  accountId      String
  templateId     String
  targetListId   String?
  messagePreview String?
  maxPerHour     Int     @default(20)
  maxPerDay      Int     @default(200)
  sentCount      Int     @default(0)
  successCount   Int     @default(0)
  startedAt      DateTime?
  completedAt    DateTime?
  targetsJson    String  @default("[]")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  account        Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  template       Template @relation(fields: [templateId], references: [id], onDelete: Restrict)
  targetList     TargetList? @relation(fields: [targetListId], references: [id], onDelete: SetNull)
  logs           LogEntry[]
}

model LogEntry {
  id         String   @id @default(cuid())
  level      String   @default("INFO")
  message    String
  metadata   String?
  createdAt  DateTime @default(now())
  accountId  String?
  campaignId String?
  account    Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  campaign   Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([level])
  @@index([campaignId])
  @@index([accountId])
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
